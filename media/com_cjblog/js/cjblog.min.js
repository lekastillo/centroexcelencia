var CjBlogFactory = {};

(function($){
	CjBlogFactory.init = function(){
		$('.tooltip-hover').tooltip();
	};
	
	CjBlogFactory.init_profile = function(){
		$('.btn-edit-about').click(function(){
			$('#edit-about-form').toggle('slow');
		});
		
		$('.btn-save-about').click(function(){
			$(this).button('loading');
			$.ajax({
				type: 'post',
				dataType: 'json',
				data: $('#edit-about-form').serialize(),
				url: $('#edit-about-form').attr('action'),
				success: function(data, statusText, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#modal-error-message').find('.modal-body').html(data.error);
						$('#modal-error-message').modal('show');
					} else {
						$('.user-about').html($('textarea[name="user-about"]').val());
						$('#edit-about-form').toggle('slow');
					}
					$('.btn-save-about').button('reset');
				}
			});
		});
		
		$('.btn-select-image').click(function(){
			$('#input-avatar-image').click();
		});
		
		$('#input-avatar-image').change(function(){
			$('.btn-select-image').button('loading');
			$('.avatar-upload-error').hide();
			$('#avatar-upload-form').ajaxSubmit({
				dataType: 'json',
				success: function(data) {
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('.avatar-upload-error').show().find('.alert').html(data.error);
						$('.btn-select-image').button('reset');
						$('#input-avatar-image').val('');
					}else{
						$('.change-avatar-step1').hide();
						$('.change-avatar-step2').show();
						$('.change-avatar-step2').find('.new-avatar-image').empty().append($('<img>', {'src': data.avatar.url, 'width': data.avatar.width, height: data.avatar.height}));
						$('#modal-change-avatar').find('input[name="file_name"]').val(data.avatar.file_name);
						$('.change-avatar-step2').find('.new-avatar-image').find('img').Jcrop({
							aspectRatio: 1,
							minSize: [128,128],
							setSelect: [0, 0, 128, 128],
							boxWidth: 600, 
							boxHeight: 600,
							onSelect: function(c){
								$('#modal-change-avatar').find('input[name="coords"]').val(c.x+','+c.y+','+c.x2+','+c.y2+','+c.w+','+c.h);
							}
						});
						$('.btn-save-avatar').show();
					}
				}
			});
		});
		
		$('.btn-save-avatar').click(function(){
			$(this).button('loading');
			$('.avatar-upload-error').hide();
			$.ajax({
				dataType: 'json',
				type: 'post',
				data: $('#save-avatar-form').serialize(),
				url: $('#save-avatar-form').attr('action'),
				success: function(data) {
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('.avatar-upload-error').show().find('.alert').html(data.error);
					}else{
						$('.profile-container').find('.avatar').attr('src', data.src);
						$('#modal-change-avatar').modal('hide');
					}
					$('.btn-save-avatar').button('reset');
				}
			});
		});
		
		$('.btn-edit-avatar').click(function(){
			$('.change-avatar-step1').show();
			$('.change-avatar-step2').hide();
			$('.btn-select-image').button('reset');
			$('.btn-save-avatar').button('reset');
			$('#modal-change-avatar').modal('show');
			$('#input-avatar-image').val('');
			$('.avatar-upload-error').hide();
		});
	};
	
	CjBlogFactory.init_articles = function(){
		$('#sub-categories-content').on('hidden', function () {
			$('#sub-categories').find('i').removeClass('icon-chevron-down').addClass('icon-chevron-up');
		}).on('shown', function(){
			$('#sub-categories').find('i').removeClass('icon-chevron-up').addClass('icon-chevron-down');
		});
	};
	
	CjBlogFactory.init_article = function(){
		$('#btn-add-to-favorites').click(function(){
			$(this).button('loading');
			var button = $(this);
			$.ajax({
				url: button.attr('href'),
				type: 'get',
				dataType: 'json',
				success: function(data) {
					if(typeof data.error != 'undefined' && data.error.length > 0){
						// error- do something here
					} else {
						button.parent().find('.favorites').html(data.data);
						button.remove();
					}
					button.button('reset');
				}
			});
			return false;
		});
		
		$('#btn-remove-favorite').click(function(){
			$(this).button('loading');
			var button = $(this);
			$.ajax({
				url: button.attr('href'),
				type: 'get',
				dataType: 'json',
				success: function(data) {
					if(typeof data.error != 'undefined' && data.error.length > 0){
						// error- do something here
					} else {
						button.parent().find('.favorites').html(data.data);
						button.remove();
					}
					button.button('reset');
				}
			});
			return false;
		});

		var rating = $('.article-star-rating-readonly');
		rating.raty({
			path: cjlib_loc+'/jquery/images',
			round : { down: .25, full: .6, up: .76 },
			score: rating.attr('data-rating-score'),
			halfShow: true,
			readOnly: true,
			noRatedMsg: (typeof rating.attr('data-rating-noratemsg') != 'undefined' ? rating.attr('data-rating-noratemsg') : ''),
			hints: (typeof rating.attr('data-rating-hints') != 'undefined' ? rating.attr('data-rating-hints').split(',') : new Array())
		}).removeAttr('title').find('img').tooltip();

		rating = $('.article-star-rating');
		rating.raty({
			path: cjlib_loc+'/jquery/images',
			round : { down: .25, full: .6, up: .76 },
			score: rating.attr('data-rating-score'),
			halfShow: true,
			cancel: true,
			readOnly: (typeof rating.attr('data-rating-readonly') != 'undefined' ? (rating.attr('data-rating-readonly') == 1) : false),
			noRatedMsg: (typeof rating.attr('data-rating-noratemsg') != 'undefined' ? rating.attr('data-rating-noratemsg') : ''),
			cancelHint: (typeof rating.attr('data-rating-cancelhint') != 'undefined' ? rating.attr('data-rating-cancelhint') : ''),
			hints: (typeof rating.attr('data-rating-hints') != 'undefined' ? rating.attr('data-rating-hints').split(',') : new Array()),
			click: function(score, evt){
				$.ajax({
					url: rating.attr('data-rating-url'),
					type: 'post',
					dataType: 'json',
					data: 'rating='+score,
					success: function(data) {
						if(typeof data.error != 'undefined' && data.error.length > 0){
							rating.popover({placement: 'top', content: data.error});
						} else {
							$('#article-rating-info').html(data.data);
							rating.raty('readOnly', true);
						}
					}
				});
			}
		}).removeAttr('title').find('img').tooltip();
	};
	
	CjBlogFactory.init_form = function(){
		
		$('.cjblog-tags').on('click', '.btn-remove-tag', function(){
			$(this).closest('li').hide('slow', function(){ $(this).closest('li').remove(); });
		});
		
		$('#input-tags').typeahead({
			minLength: 1,
			menu: '<ul class="typeahead dropdown-menu"></ul>',
			item: '<li><a href="#"></a></li>',
			source: function (query, process) {
				$.getJSON($('#url-get-tags').text(), { search: query }, function (data) {
					results = new Array();
					$.each(data.tags, function (i, tag) {
						var found = false;
						$('.cjblog-tags').find('.tag-item').each(function(){
							if(tag.tag_text.toLowerCase() == $(this).text().toLowerCase()){
								found  = true;
								return false;
							}
						});
						if(!found) {
							if(null != tag.description){
								results.push('<li><div class="tag-value">'+tag.tag_text+'</div><div>'+tag.description.substring(0, 100)+'...</div></li>');
							}else{
								results.push('<li><div class="tag-value">'+tag.tag_text+'</div></li>');
							}
						}
					});
					process(results);
				});
			},
			highlighter: function (item) {
			    var regex = new RegExp( '(' + this.query + ')', 'gi' );
			    var value = $('<div>').html(item).find('.tag-value').html().replace(regex, "<strong>$1</strong>");
			    var rtn = $('<div>', {'class': 'dummy'}).html(item);
			    rtn.find('.tag-value').html(value);
			    
			    return rtn.html();
			},
			updater: function (item) {
				var found = false;
				var value = $('<div>').html(item).find('.tag-value').text();
				$('.cjblog-tags').find('.tag-item').each(function(){
					if(value.toLowerCase() == $(this).text().toLowerCase()){
						found  = true;
						return false;
					}
				});
				
				if(!found){
					$('.cjblog-tags').find('ul').append(
						$('<li>', {'id': 0, 'class': 'label'}).append(
							$('<a>', {'class': 'btn-remove-tag', 'href': '#', 'onclick': 'return false'}).append($('<i>', {'class': 'icon-remove icon-white'})),
							'&nbsp;',
							$('<span>', {'class': 'tag-item'}).append(value)
						));
					$('#input-tags').val('');
				}
				
				return '';
			}
		});
		
		$('#input-tags').keypress(function(e){
			if ( e.which == 13 || e.which == 59 || e.which == 44){
				e.preventDefault();
				var found = false;
				var value = $.trim($('#input-tags').val());
				
				if(value == '' || value.length < 2) return false;
				
				$('.cjblog-tags').find('.tag-item').each(function(){
					if(value.toLowerCase() == $(this).text().toLowerCase()){
						found  = true;
						return false;
					}
				});
				
				if(!found){
					$('.cjblog-tags').find('ul').append(
						$('<li>', {'id': 0, 'class': 'label'}).append(
							$('<a>', {'class': 'btn-remove-tag', 'href': '#', 'onclick': 'return false'}).append($('<i>', {'class': 'icon-remove icon-white'})),
							'&nbsp;',
							$('<span>', {'class': 'tag-item'}).append(value)
						));
					$('#input-tags').val('');
				}
			}
		});
		
		$('.btn-submit-form').click(function(){
			var tags = new Array();
			$('.cjblog-tags').find('.tag-item').each(function(){
				tags.push($(this).text());
			});
			$('.cjblog-tags').find('input[name="tags"]').val(tags.join(','));
			Joomla.submitbutton('article.save');
		});
	};
	
	CjBlogFactory.init_tags = function(){
		$('.btn-edit-tag').click(function(){
			var button = $(this).removeClass('icon-edit').addClass('icon btn-progress');
			$.ajax({
				type: 'post',
				dataType: 'json',
				url: $('#url-get-tag-details').text(),
				data: {tagid: button.closest('.tag-item-wrapper').find('input[name="tagid"]').val()},
				success: function(data, status, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					}else{
						$('#edit-tag-modal').find('input[name="tagid"]').val(data.tag.id);
						$('#edit-tag-modal').find('input[name="name"]').val(data.tag.tag_text);
						$('#edit-tag-modal').find('input[name="alias"]').val(data.tag.alias);
						$('#edit-tag-modal').find('textarea[name="description"]').val(data.tag.description);
						
						$('.btn-submit').off().click(function(){
							var submit = $(this).button('loading');
							$.ajax({
								type: 'post',
								dataType: 'json',
								url: $('.tag-form').attr('action'),
								data: $('.tag-form').serialize(),
								success: function(data, status, xhr, form){
									submit.button('reset');
									if(typeof data.error != 'undefined' && data.error.length > 0){
										$('#edit-tag-modal').find('.error-desc').html(data.error).parent().show();
									}else{
										button.closest('div').find('.tag-desc').html($('.tag-form').find('textarea[name="description"]').val());
										button.closest('div').find('.tag-item').html($('.tag-form').find('input[name="name"]').val());
										$('#edit-tag-modal').modal('hide');
									}
								}
							});
						});
						
						$('#edit-tag-modal').modal('show');
					}
					
					button.removeClass('btn-progress').addClass('icon-edit');
				}
			});
		});
		
		$('.btn-delete-tag').click(function(){
			var button = $(this);
			$('#confirm-modal').modal('show').find('.btn-confirm').off().click(function(){
				var me = $(this).button('reset');
				me.button('loading');
				$.ajax({
					url: $('#url-delete-tag').text(),
					data: {tagid: button.closest('.tag-item-wrapper').find('input[name="tagid"]').val()},
					type: 'post',
					dataType: 'json',
					success: function(data, status, xhr, form){
						if(typeof data.error != 'undefined' && data.error.length > 0){
							$('#message-modal').find('.modal-body').html(data.error);
							$('#message-modal').modal('show');
							me.button('reset');
						}else{
							button.closest('.tag-item-wrapper').css('background-color', '#ccc').find('a').remove();
						}
						$('#confirm-modal').modal('hide');
						me.button('reset');
					}
				});
			});
			return false;
		});
	};
})(jQuery);

jQuery(document).ready(function($){
	CjBlogFactory.init();
	var pageid = $('#cjblog_page_id').val();
	
	if(pageid == 'profile') CjBlogFactory.init_profile();
	if(pageid == 'articles') CjBlogFactory.init_articles();
	if(pageid == 'article') CjBlogFactory.init_article();
	if(pageid == 'form') CjBlogFactory.init_form();
	if(pageid == 'tags') CjBlogFactory.init_tags();
});